!function(a){"object"==typeof exports&&"object"==typeof module?a(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):"function"==typeof define&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],a):a(CodeMirror)}(function(a){"use strict";function d(b,d,e){var f,h,g,i,j,k,l,m,n;if(0>e&&0==d.ch)return b.clipPos(c(d.line-1));if(f=b.getLine(d.line),e>0&&d.ch>=f.length)return b.clipPos(c(d.line+1,0));for(g="start",i=d.ch,j=i,k=0>e?0:f.length,l=0;j!=k;j+=e,l++)if(m=f.charAt(0>e?j-1:j),n="_"!=m&&a.isWordChar(m)?"w":"o","w"==n&&m.toUpperCase()==m&&(n="W"),"start"==g)"o"!=n?(g="in",h=n):i=j+e;else if("in"==g&&h!=n){if("w"==h&&"W"==n&&0>e&&j--,"W"==h&&"w"==n&&e>0){if(j==i+1){h="w";continue}j--}break}return c(d.line,j)}function e(a,b){a.extendSelectionsBy(function(c){return a.display.shift||a.doc.extend||c.empty()?d(a.doc,c.head,b):0>b?c.from():c.to()})}function f(b,d){return b.isReadOnly()?a.Pass:(b.operation(function(){var g,h,i,a=b.listSelections().length,e=[],f=-1;for(g=0;a>g;g++)h=b.listSelections()[g].head,h.line<=f||(i=c(h.line+(d?0:1),0),b.replaceRange("\n",i,null,"+insertLine"),b.indentLine(i.line,null,!0),e.push({head:i,anchor:i}),f=h.line+1);b.setSelections(e)}),b.execCommand("indentAuto"),void 0)}function g(b,d){for(var e=d.ch,f=e,g=b.getLine(d.line);e&&a.isWordChar(g.charAt(e-1));)--e;for(;f<g.length&&a.isWordChar(g.charAt(f));)++f;return{from:c(d.line,e),to:c(d.line,f),word:g.slice(e,f)}}function h(a,b){var e,f,g,h,i,c=a.listSelections(),d=[];for(e=0;e<c.length;e++)f=c[e],g=a.findPosV(f.anchor,b,"line",f.anchor.goalColumn),h=a.findPosV(f.head,b,"line",f.head.goalColumn),g.goalColumn=null!=f.anchor.goalColumn?f.anchor.goalColumn:a.cursorCoords(f.anchor,"div").left,h.goalColumn=null!=f.head.goalColumn?f.head.goalColumn:a.cursorCoords(f.head,"div").left,i={anchor:g,head:h},d.push(f),d.push(i);a.setSelections(d)}function i(b,c,d){for(var e=0;e<b.length;e++)if(0==a.cmpPos(b[e].from(),c)&&0==a.cmpPos(b[e].to(),d))return!0;return!1}function k(b){var f,g,h,i,k,l,d=b.listSelections(),e=[];for(f=0;f<d.length;f++){if(g=d[f],h=g.head,i=b.scanForBracket(h,-1),!i)return!1;for(;;){if(k=b.scanForBracket(h,1),!k)return!1;if(k.ch==j.charAt(j.indexOf(i.ch)+1)){if(l=c(i.pos.line,i.pos.ch+1),0!=a.cmpPos(l,g.from())||0!=a.cmpPos(k.pos,g.to())){e.push({anchor:l,head:k.pos});break}if(i=b.scanForBracket(i.pos,-1),!i)return!1}h=c(k.pos.line,k.pos.ch+1)}}return b.setSelections(e),!0}function l(a){return a?/\bpunctuation\b/.test(a)?a:void 0:null}function m(b,d){var g,e,f,h,i,j,k;if(b.isReadOnly())return a.Pass;for(e=b.listSelections(),f=[],h=0;h<e.length;h++)if(i=e[h],!i.empty()){for(j=i.from().line,k=i.to().line;h<e.length-1&&e[h+1].from().line==k;)k=e[++h].to().line;e[h].to().ch||k--,f.push(j,k)}f.length?g=!0:f.push(b.firstLine(),b.lastLine()),b.operation(function(){var e,h,i,j,k,l,a=[];for(e=0;e<f.length;e+=2)h=f[e],i=f[e+1],j=c(h,0),k=c(i),l=b.getRange(j,k,!1),d?l.sort():l.sort(function(a,b){var c=a.toUpperCase(),d=b.toUpperCase();return c!=d&&(a=c,b=d),b>a?-1:a==b?0:1}),b.replaceRange(l,j,k),g&&a.push({anchor:j,head:c(i+1,0)});g&&b.setSelections(a,0)})}function n(b,c){b.operation(function(){var h,i,j,k,d=b.listSelections(),e=[],f=[];for(h=0;h<d.length;h++)i=d[h],i.empty()?(e.push(h),f.push("")):f.push(c(b.getRange(i.from(),i.to())));for(b.replaceSelections(f,"around","case"),h=e.length-1;h>=0;h--)i=d[e[h]],j&&a.cmpPos(i.head,j)>0||(k=g(b,i.head),j=k.from,b.replaceRange(c(k.word),k.from,k.to))})}function o(b){var e,c=b.getCursor("from"),d=b.getCursor("to");if(0==a.cmpPos(c,d)){if(e=g(b,c),!e.word)return;c=e.from,d=e.to}return{from:c,to:d,query:b.getRange(c,d),word:e}}function p(a,b){var e,f,d=o(a);d&&(e=d.query,f=a.getSearchCursor(e,b?d.to:d.from),(b?f.findNext():f.findPrevious())?a.setSelection(f.from(),f.to()):(f=a.getSearchCursor(e,b?c(a.firstLine(),0):a.clipPos(c(a.lastLine()))),(b?f.findNext():f.findPrevious())?a.setSelection(f.from(),f.to()):d.word&&a.setSelection(d.from,d.to)))}var j,q,r,b=a.commands,c=a.Pos;b.goSubwordLeft=function(a){e(a,-1)},b.goSubwordRight=function(a){e(a,1)},b.scrollLineUp=function(a){var c,b=a.getScrollInfo();a.somethingSelected()||(c=a.lineAtHeight(b.top+b.clientHeight,"local"),a.getCursor().line>=c&&a.execCommand("goLineUp")),a.scrollTo(null,b.top-a.defaultTextHeight())},b.scrollLineDown=function(a){var c,b=a.getScrollInfo();a.somethingSelected()||(c=a.lineAtHeight(b.top,"local")+1,a.getCursor().line<=c&&a.execCommand("goLineDown")),a.scrollTo(null,b.top+a.defaultTextHeight())},b.splitSelectionByLine=function(a){var e,f,g,h,b=a.listSelections(),d=[];for(e=0;e<b.length;e++)for(f=b[e].from(),g=b[e].to(),h=f.line;h<=g.line;++h)g.line>f.line&&h==g.line&&0==g.ch||d.push({anchor:h==f.line?f:c(h,0),head:h==g.line?g:c(h)});a.setSelections(d,0)},b.singleSelectionTop=function(a){var b=a.listSelections()[0];a.setSelection(b.anchor,b.head,{scroll:!1})},b.selectLine=function(a){var e,f,b=a.listSelections(),d=[];for(e=0;e<b.length;e++)f=b[e],d.push({anchor:c(f.from().line,0),head:c(f.to().line+1,0)});a.setSelections(d)},b.insertLineAfter=function(a){return f(a,!1)},b.insertLineBefore=function(a){return f(a,!0)},b.selectNextOccurrence=function(b){var h,j,k,l,m,d=b.getCursor("from"),e=b.getCursor("to"),f=b.state.sublimeFindFullWord==b.doc.sel;if(0==a.cmpPos(d,e)){if(h=g(b,d),!h.word)return;b.setSelection(h.from,h.to),f=!0}else{if(j=b.getRange(d,e),k=f?new RegExp("\\b"+j+"\\b"):j,l=b.getSearchCursor(k,e),m=l.findNext(),m||(l=b.getSearchCursor(k,c(b.firstLine(),0)),m=l.findNext()),!m||i(b.listSelections(),l.from(),l.to()))return;b.addSelection(l.from(),l.to())}f&&(b.state.sublimeFindFullWord=b.doc.sel)},b.skipAndSelectNextOccurrence=function(c){var d=c.getCursor("anchor"),e=c.getCursor("head");b.selectNextOccurrence(c),0!=a.cmpPos(d,e)&&c.doc.setSelections(c.doc.listSelections().filter(function(a){return a.anchor!=d||a.head!=e}))},b.addCursorToPrevLine=function(a){h(a,-1)},b.addCursorToNextLine=function(a){h(a,1)},j="(){}[]",b.selectScope=function(a){k(a)||a.execCommand("selectAll")},b.selectBetweenBrackets=function(b){return k(b)?void 0:a.Pass},b.goToBracket=function(b){b.extendSelectionsBy(function(d){var f,e=b.scanForBracket(d.head,1,l(b.getTokenTypeAt(d.head)));return e&&0!=a.cmpPos(e.pos,d.head)?e.pos:(f=b.scanForBracket(d.head,-1,l(b.getTokenTypeAt(c(d.head.line,d.head.ch+1)))),f&&c(f.pos.line,f.pos.ch+1)||d.head)})},b.swapLineUp=function(b){var d,e,f,g,h,i,j,k;if(b.isReadOnly())return a.Pass;for(d=b.listSelections(),e=[],f=b.firstLine()-1,g=[],h=0;h<d.length;h++)i=d[h],j=i.from().line-1,k=i.to().line,g.push({anchor:c(i.anchor.line-1,i.anchor.ch),head:c(i.head.line-1,i.head.ch)}),0!=i.to().ch||i.empty()||--k,j>f?e.push(j,k):e.length&&(e[e.length-1]=k),f=k;b.operation(function(){var a,d,f,h;for(a=0;a<e.length;a+=2)d=e[a],f=e[a+1],h=b.getLine(d),b.replaceRange("",c(d,0),c(d+1,0),"+swapLine"),f>b.lastLine()?b.replaceRange("\n"+h,c(b.lastLine()),null,"+swapLine"):b.replaceRange(h+"\n",c(f,0),null,"+swapLine");b.setSelections(g),b.scrollIntoView()})},b.swapLineDown=function(b){var d,e,f,g,h,i,j;if(b.isReadOnly())return a.Pass;for(d=b.listSelections(),e=[],f=b.lastLine()+1,g=d.length-1;g>=0;g--)h=d[g],i=h.to().line+1,j=h.from().line,0!=h.to().ch||h.empty()||i--,f>i?e.push(i,j):e.length&&(e[e.length-1]=j),f=j;b.operation(function(){var a,d,f,g;for(a=e.length-2;a>=0;a-=2)d=e[a],f=e[a+1],g=b.getLine(d),d==b.lastLine()?b.replaceRange("",c(d-1),c(d),"+swapLine"):b.replaceRange("",c(d,0),c(d+1,0),"+swapLine"),b.replaceRange(g+"\n",c(f,0),null,"+swapLine");b.scrollIntoView()})},b.toggleCommentIndented=function(a){a.toggleComment({indent:!0})},b.joinLines=function(a){var e,f,g,h,i,b=a.listSelections(),d=[];for(e=0;e<b.length;e++){for(f=b[e],g=f.from(),h=g.line,i=f.to().line;e<b.length-1&&b[e+1].from().line==i;)i=b[++e].to().line;d.push({start:h,end:i,anchor:!f.empty()&&g})}a.operation(function(){var f,g,i,h,j,k,b=0,e=[];for(f=0;f<d.length;f++){for(g=d[f],h=g.anchor&&c(g.anchor.line-b,g.anchor.ch),j=g.start;j<=g.end;j++)k=j-b,j==g.end&&(i=c(k,a.getLine(k).length+1)),k<a.lastLine()&&(a.replaceRange(" ",c(k),c(k+1,/^\s*/.exec(a.getLine(k+1))[0].length)),++b);e.push({anchor:h||i,head:i})}a.setSelections(e,0)})},b.duplicateLine=function(a){a.operation(function(){var d,e,b=a.listSelections().length;for(d=0;b>d;d++)e=a.listSelections()[d],e.empty()?a.replaceRange(a.getLine(e.head.line)+"\n",c(e.head.line,0)):a.replaceRange(a.getRange(e.from(),e.to()),e.from());a.scrollIntoView()})},b.sortLines=function(a){m(a,!0)},b.sortLinesInsensitive=function(a){m(a,!1)},b.nextBookmark=function(a){var c,d,b=a.state.sublimeBookmarks;if(b)for(;b.length;)if(c=b.shift(),d=c.find())return b.push(c),a.setSelection(d.from,d.to)},b.prevBookmark=function(a){var c,b=a.state.sublimeBookmarks;if(b)for(;b.length;){if(b.unshift(b.pop()),c=b[b.length-1].find())return a.setSelection(c.from,c.to);b.pop()}},b.toggleBookmark=function(a){var d,e,f,g,h,i,b=a.listSelections(),c=a.state.sublimeBookmarks||(a.state.sublimeBookmarks=[]);for(d=0;d<b.length;d++){for(e=b[d].from(),f=b[d].to(),g=b[d].empty()?a.findMarksAt(e):a.findMarks(e,f),h=0;h<g.length;h++)if(g[h].sublimeBookmark){for(g[h].clear(),i=0;i<c.length;i++)c[i]==g[h]&&c.splice(i--,1);break}h==g.length&&c.push(a.markText(e,f,{sublimeBookmark:!0,clearWhenEmpty:!1}))}},b.clearBookmarks=function(a){var c,b=a.state.sublimeBookmarks;if(b)for(c=0;c<b.length;c++)b[c].clear();b.length=0},b.selectBookmarks=function(a){var d,e,b=a.state.sublimeBookmarks,c=[];if(b)for(d=0;d<b.length;d++)e=b[d].find(),e?c.push({anchor:e.from,head:e.to}):b.splice(d--,0);c.length&&a.setSelections(c,0)},b.smartBackspace=function(b){return b.somethingSelected()?a.Pass:(b.operation(function(){var f,g,h,i,j,k,d=b.listSelections(),e=b.getOption("indentUnit");for(f=d.length-1;f>=0;f--)g=d[f].head,h=b.getRange({line:g.line,ch:0},g),i=a.countColumn(h,null,b.getOption("tabSize")),j=b.findPosH(g,-1,"char",!1),h&&!/\S/.test(h)&&0==i%e&&(k=new c(g.line,a.findColumn(h,i-e,e)),k.ch!=g.ch&&(j=k)),b.replaceRange("",j,g,"+delete")}),void 0)},b.delLineRight=function(a){a.operation(function(){var d,b=a.listSelections();for(d=b.length-1;d>=0;d--)a.replaceRange("",b[d].anchor,c(b[d].to().line),"+delete");a.scrollIntoView()})},b.upcaseAtCursor=function(a){n(a,function(a){return a.toUpperCase()})},b.downcaseAtCursor=function(a){n(a,function(a){return a.toLowerCase()})},b.setSublimeMark=function(a){a.state.sublimeMark&&a.state.sublimeMark.clear(),a.state.sublimeMark=a.setBookmark(a.getCursor())},b.selectToSublimeMark=function(a){var b=a.state.sublimeMark&&a.state.sublimeMark.find();b&&a.setSelection(a.getCursor(),b)},b.deleteToSublimeMark=function(b){var d,e,f,c=b.state.sublimeMark&&b.state.sublimeMark.find();c&&(d=b.getCursor(),e=c,a.cmpPos(d,e)>0&&(f=e,e=d,d=f),b.state.sublimeKilled=b.getRange(d,e),b.replaceRange("",d,e))},b.swapWithSublimeMark=function(a){var b=a.state.sublimeMark&&a.state.sublimeMark.find();b&&(a.state.sublimeMark.clear(),a.state.sublimeMark=a.setBookmark(a.getCursor()),a.setCursor(b))},b.sublimeYank=function(a){null!=a.state.sublimeKilled&&a.replaceSelection(a.state.sublimeKilled,null,"paste")},b.showInCenter=function(a){var b=a.cursorCoords(null,"local");a.scrollTo(null,(b.top+b.bottom)/2-a.getScrollInfo().clientHeight/2)},b.findUnder=function(a){p(a,!0)},b.findUnderPrevious=function(a){p(a,!1)},b.findAllUnder=function(a){var c,d,e,b=o(a);if(b){for(c=a.getSearchCursor(b.query),d=[],e=-1;c.findNext();)d.push({anchor:c.from(),head:c.to()}),c.from().line<=b.from.line&&c.from().ch<=b.from.ch&&e++;a.setSelections(d,e)}},q=a.keyMap,q.macSublime={"Cmd-Left":"goLineStartSmart","Shift-Tab":"indentLess","Shift-Ctrl-K":"deleteLine","Alt-Q":"wrapLines","Ctrl-Left":"goSubwordLeft","Ctrl-Right":"goSubwordRight","Ctrl-Alt-Up":"scrollLineUp","Ctrl-Alt-Down":"scrollLineDown","Cmd-L":"selectLine","Shift-Cmd-L":"splitSelectionByLine",Esc:"singleSelectionTop","Cmd-Enter":"insertLineAfter","Shift-Cmd-Enter":"insertLineBefore","Cmd-D":"selectNextOccurrence","Shift-Cmd-Space":"selectScope","Shift-Cmd-M":"selectBetweenBrackets","Cmd-M":"goToBracket","Cmd-Ctrl-Up":"swapLineUp","Cmd-Ctrl-Down":"swapLineDown","Cmd-/":"toggleCommentIndented","Cmd-J":"joinLines","Shift-Cmd-D":"duplicateLine",F5:"sortLines","Cmd-F5":"sortLinesInsensitive",F2:"nextBookmark","Shift-F2":"prevBookmark","Cmd-F2":"toggleBookmark","Shift-Cmd-F2":"clearBookmarks","Alt-F2":"selectBookmarks",Backspace:"smartBackspace","Cmd-K Cmd-D":"skipAndSelectNextOccurrence","Cmd-K Cmd-K":"delLineRight","Cmd-K Cmd-U":"upcaseAtCursor","Cmd-K Cmd-L":"downcaseAtCursor","Cmd-K Cmd-Space":"setSublimeMark","Cmd-K Cmd-A":"selectToSublimeMark","Cmd-K Cmd-W":"deleteToSublimeMark","Cmd-K Cmd-X":"swapWithSublimeMark","Cmd-K Cmd-Y":"sublimeYank","Cmd-K Cmd-C":"showInCenter","Cmd-K Cmd-G":"clearBookmarks","Cmd-K Cmd-Backspace":"delLineLeft","Cmd-K Cmd-1":"foldAll","Cmd-K Cmd-0":"unfoldAll","Cmd-K Cmd-J":"unfoldAll","Ctrl-Shift-Up":"addCursorToPrevLine","Ctrl-Shift-Down":"addCursorToNextLine","Cmd-F3":"findUnder","Shift-Cmd-F3":"findUnderPrevious","Alt-F3":"findAllUnder","Shift-Cmd-[":"fold","Shift-Cmd-]":"unfold","Cmd-I":"findIncremental","Shift-Cmd-I":"findIncrementalReverse","Cmd-H":"replace",F3:"findNext","Shift-F3":"findPrev",fallthrough:"macDefault"},a.normalizeKeyMap(q.macSublime),q.pcSublime={"Shift-Tab":"indentLess","Shift-Ctrl-K":"deleteLine","Alt-Q":"wrapLines","Ctrl-T":"transposeChars","Alt-Left":"goSubwordLeft","Alt-Right":"goSubwordRight","Ctrl-Up":"scrollLineUp","Ctrl-Down":"scrollLineDown","Ctrl-L":"selectLine","Shift-Ctrl-L":"splitSelectionByLine",Esc:"singleSelectionTop","Ctrl-Enter":"insertLineAfter","Shift-Ctrl-Enter":"insertLineBefore","Ctrl-D":"selectNextOccurrence","Shift-Ctrl-Space":"selectScope","Shift-Ctrl-M":"selectBetweenBrackets","Ctrl-M":"goToBracket","Shift-Ctrl-Up":"swapLineUp","Shift-Ctrl-Down":"swapLineDown","Ctrl-/":"toggleCommentIndented","Ctrl-J":"joinLines","Shift-Ctrl-D":"duplicateLine",F9:"sortLines","Ctrl-F9":"sortLinesInsensitive",F2:"nextBookmark","Shift-F2":"prevBookmark","Ctrl-F2":"toggleBookmark","Shift-Ctrl-F2":"clearBookmarks","Alt-F2":"selectBookmarks",Backspace:"smartBackspace","Ctrl-K Ctrl-D":"skipAndSelectNextOccurrence","Ctrl-K Ctrl-K":"delLineRight","Ctrl-K Ctrl-U":"upcaseAtCursor","Ctrl-K Ctrl-L":"downcaseAtCursor","Ctrl-K Ctrl-Space":"setSublimeMark","Ctrl-K Ctrl-A":"selectToSublimeMark","Ctrl-K Ctrl-W":"deleteToSublimeMark","Ctrl-K Ctrl-X":"swapWithSublimeMark","Ctrl-K Ctrl-Y":"sublimeYank","Ctrl-K Ctrl-C":"showInCenter","Ctrl-K Ctrl-G":"clearBookmarks","Ctrl-K Ctrl-Backspace":"delLineLeft","Ctrl-K Ctrl-1":"foldAll","Ctrl-K Ctrl-0":"unfoldAll","Ctrl-K Ctrl-J":"unfoldAll","Ctrl-Alt-Up":"addCursorToPrevLine","Ctrl-Alt-Down":"addCursorToNextLine","Ctrl-F3":"findUnder","Shift-Ctrl-F3":"findUnderPrevious","Alt-F3":"findAllUnder","Shift-Ctrl-[":"fold","Shift-Ctrl-]":"unfold","Ctrl-I":"findIncremental","Shift-Ctrl-I":"findIncrementalReverse","Ctrl-H":"replace",F3:"findNext","Shift-F3":"findPrev",fallthrough:"pcDefault"},a.normalizeKeyMap(q.pcSublime),r=q.default==q.macDefault,q.sublime=r?q.macSublime:q.pcSublime});