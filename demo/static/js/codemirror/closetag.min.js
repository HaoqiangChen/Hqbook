!function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],a):a(CodeMirror)}(function(a){function d(d){var e,f,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;if(d.getOption("disableInput"))return a.Pass;for(e=d.listSelections(),f=[],i=d.getOption("autoCloseTags"),j=0;j<e.length;j++){if(!e[j].empty())return a.Pass;if(k=e[j].head,l=d.getTokenAt(k),m=a.innerMode(d.getMode(),l.state),n=m.state,o=m.mode.xmlCurrentTag&&m.mode.xmlCurrentTag(n),p=o&&o.name,!p)return a.Pass;if(q="html"==m.mode.configuration,r="object"==typeof i&&i.dontCloseTags||q&&b,s="object"==typeof i&&i.indentTags||q&&c,l.end>k.ch&&(p=p.slice(0,p.length-l.end+k.ch)),t=p.toLowerCase(),!p||"string"==l.type&&(l.end!=k.ch||!/[\"\']/.test(l.string.charAt(l.string.length-1))||1==l.string.length)||"tag"==l.type&&o.close||l.string.indexOf("/")==k.ch-l.start-1||r&&g(r,t)>-1||h(d,m.mode.xmlCurrentContext&&m.mode.xmlCurrentContext(n)||[],p,k,!0))return a.Pass;u="object"==typeof i&&i.emptyTags,u&&g(u,p)>-1?f[j]={text:"/>",newPos:a.Pos(k.line,k.ch+2)}:(v=s&&g(s,t)>-1,f[j]={indent:v,text:">"+(v?"\n\n":"")+"</"+p+">",newPos:v?a.Pos(k.line+1,0):a.Pos(k.line,k.ch+1)})}for(w="object"==typeof i&&i.dontIndentOnAutoClose,j=e.length-1;j>=0;j--)x=f[j],d.replaceRange(x.text,e[j].head,e[j].anchor,"+insert"),y=d.listSelections().slice(0),y[j]={head:x.newPos,anchor:x.newPos},d.setSelections(y),!w&&x.indent&&(d.indentLine(x.newPos.line,null,!0),d.indentLine(x.newPos.line+1,null,!0))}function e(b,c){var j,k,l,m,n,o,p,q,d=b.listSelections(),e=[],f=c?"/":"</",g=b.getOption("autoCloseTags"),i="object"==typeof g&&g.dontIndentOnSlash;for(j=0;j<d.length;j++){if(!d[j].empty())return a.Pass;if(k=d[j].head,l=b.getTokenAt(k),m=a.innerMode(b.getMode(),l.state),n=m.state,c&&("string"==l.type||"<"!=l.string.charAt(0)||l.start!=k.ch-1))return a.Pass;if(p="xml"!=m.mode.name&&"htmlmixed"==b.getMode().name,p&&"javascript"==m.mode.name)o=f+"script";else if(p&&"css"==m.mode.name)o=f+"style";else{if(q=m.mode.xmlCurrentContext&&m.mode.xmlCurrentContext(n),!q||q.length&&h(b,q,q[q.length-1],k))return a.Pass;o=f+q[q.length-1]}">"!=b.getLine(k.line).charAt(l.end)&&(o+=">"),e[j]=o}if(b.replaceSelections(e),d=b.listSelections(),!i)for(j=0;j<d.length;j++)(j==d.length-1||d[j].head.line<d[j+1].head.line)&&b.indentLine(d[j].head.line)}function f(b){return b.getOption("disableInput")?a.Pass:e(b,!0)}function g(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0,d=a.length;d>c;++c)if(a[c]==b)return c;return-1}function h(b,c,d,e,f){var g,h,i,j,k;if(!a.scanForClosingTag)return!1;if(g=Math.min(b.lastLine()+1,e.line+500),h=a.scanForClosingTag(b,e,null,g),!h||h.tag!=d)return!1;for(i=f?1:0,j=c.length-1;j>=0&&c[j]==d;j--)++i;for(e=h.to,j=1;i>j;j++){if(k=a.scanForClosingTag(b,e,null,g),!k||k.tag!=d)return!1;e=k.to}return!0}var b,c;a.defineOption("autoCloseTags",!1,function(b,c,e){if(e!=a.Init&&e&&b.removeKeyMap("autoCloseTags"),c){var g={name:"autoCloseTags"};("object"!=typeof c||c.whenClosing!==!1)&&(g["'/'"]=function(a){return f(a)}),("object"!=typeof c||c.whenOpening!==!1)&&(g["'>'"]=function(a){return d(a)}),b.addKeyMap(g)}}),b=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],c=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"],a.commands.closeTag=function(a){return e(a)}});